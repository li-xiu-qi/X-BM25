# BM25 简介

## 第一步：用最简单的语言解释 BM25 是什么

想象一下，你有一个大图书馆，里面有很多书（文档）。现在有人问你：“帮我找几本跟‘太空旅行’最相关的书。” 你会怎么做呢？

你可能会先看看每本书里“太空”和“旅行”这两个词出现了多少次。但你不会只看这个，因为有些书很长，可能随便提到几次“太空”，但其实不重要；有些书很短，但全是“太空旅行”的内容。

你还会考虑这个词有多特别——如果“太空”在每本书里都出现，那它就不稀奇；但如果只有几本书提到，它就很关键。

BM25 就是这样一个“聪明图书管理员”。它是一个算法，用来给文档打分，找出跟你的问题（查询）最相关的那些。它考虑了词频、文档长度和词的稀有度。

## 第二步：拆解 BM25 的三个核心部件

BM25 的计算有点像做菜，我们需要三种“原料”：

### 词频（TF，Term Frequency）

这是问：“这个词在一本书里出现了多少次？” 但有个问题：如果一本书超长，词频高不一定说明它更相关。所以 BM25 会“调一下味”，让长文档的词频影响变小一点（用参数 k1 和 b 控制）。

### 文档长度调整

短文档和长文档不能一视同仁。如果一本 10 页的小册子提到 5 次“太空”，可能很专注；但一本 1000 页的书提到 5 次，可能只是随便带过。BM25 用文档长度和平均文档长度来调整分数，长文档会被“惩罚”一点。

### 逆文档频率（IDF，Inverse Document Frequency）

想象一下，你在图书馆里找书。如果“太空”这个词在每本书里都出现，那它就不特别，不能帮你区分哪些书更相关。但如果“太空”只在几本书里出现，那这些书就很特别，可能更符合你的需求。

IDF 就是用来衡量一个词有多特别的。它会给那些在少数文档中出现的词更高的分数，因为这些词能更好地帮助你找到相关的书。具体来说，IDF 的计算方法是用一个数学公式（log 函数），让稀有词更有影响力。

简单来说，IDF 就是告诉你：“这个词在所有书里有多稀有？越稀有的词，分数越高。”

## 第三步：代码里是怎么实现的？

现在我们看看代码怎么把这个“图书管理员”做出来：

### AbstractBM25 类：基础规则

这是一个蓝图，告诉我们 BM25 需要什么：文档集合（corpus）、词频（tf）、文档频率（df）、文档长度（doc_lengths），还有平均长度（avg_doc_length）。它还定义了核心方法，比如 `_score`（算分数）和 `search`（找 Top K 结果）。

### 分词（_tokenize）

在英语里（EnglishBM25），它把句子拆成单词，去掉标点、转小写、提取词干（比如“running”变成“run”），然后扔掉没用的词（像“the”“and”这样的停用词）。在中文里（ChineseBM25），它用 jieba 把句子切成词（比如“今天天气很好”变成“今天”“天气”“很好”），也去掉停用词。

### 算分数（_score）

对查询（比如“太空旅行”），先分词成“太空”和“旅行”。对每本书，算这两个词的 TF（词频）和 IDF（稀有度），再调整一下文档长度的影响，最后加起来得出总分。

### 搜索（search）

把每本书的分数算出来，排序，挑前几个（比如 Top 5）给你。

### 保存和加载（save 和 load）

就像图书管理员把书架目录存起来，下次直接用。可以用 JSON 或 Pickle 格式保存索引，避免每次都重新算。

## 第四步：举个例子，让你感受一下

假设有 3 本书：

- 书 1（10 个词）：太空 太空 旅行 …… （短，专注）
- 书 2（100 个词）：太空 旅行 …… （长，分散）
- 书 3（50 个词）：旅行 旅行 旅行 ……（中等，没“太空”）

查询是“太空旅行”。

- 书 1：TF 高（“太空”2 次，“旅行”1 次），文档短，IDF 看词的稀有度，分数会很高。
- 书 2：TF 低（每个词才 1 次），文档长，分数被压低。
- 书 3：没“太空”，分数很低。

BM25 输出的结果：书 1 > 书 2 > 书 3。

